<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Feedback - 360 Feedback</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="site-header site-header--minimal">
            <span class="header-brand">360 Feedback</span>
        </header>

        <div id="loading">
            <div class="loading">Loading review details...</div>
        </div>

        <div class="hidden" id="already-submitted">
            <h1>Feedback Already Submitted</h1>
            <p>You have already submitted feedback for this review request. Thank you for your participation!</p>
            <a href="/"><button>Back to Home</button></a>
        </div>

        <div class="hidden" id="review-form-container">
            <h1>360 Feedback</h1>
        <p>You're providing feedback for <strong id="employee-name"></strong></p>
        <p class="message info">Your relationship: <strong id="relationship"></strong></p>

        <form id="review-form">
            <div class="form-group">
                <label>
                    What should this person START doing?
                    <button type="button" class="field-mic-btn" data-field="start_doing"
                            onclick="toggleFieldRecording('start_doing')"
                            aria-label="Record feedback for start doing">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span class="recording-spinner hidden">‚è∫</span>
                    </button>
                </label>
                <textarea id="start-doing" required maxlength="2000"
                    placeholder="Example: 'Start delegating more technical decisions to senior team members to free up time for strategic planning.'"></textarea>
            </div>

            <div class="form-group">
                <label>
                    What should this person STOP doing?
                    <button type="button" class="field-mic-btn" data-field="stop_doing"
                            onclick="toggleFieldRecording('stop_doing')"
                            aria-label="Record feedback for stop doing">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span class="recording-spinner hidden">‚è∫</span>
                    </button>
                </label>
                <textarea id="stop-doing" required maxlength="2000"
                    placeholder="Example: 'Stop taking on too many commitments at once. This leads to rushed work and missed deadlines.'"></textarea>
            </div>

            <div class="form-group">
                <label>
                    What should this person CONTINUE doing?
                    <button type="button" class="field-mic-btn" data-field="continue_doing"
                            onclick="toggleFieldRecording('continue_doing')"
                            aria-label="Record feedback for continue doing">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span class="recording-spinner hidden">‚è∫</span>
                    </button>
                </label>
                <textarea id="continue-doing" required maxlength="2000"
                    placeholder="Example: 'Continue hosting weekly team syncs. They keep everyone aligned and create space for questions.'"></textarea>
            </div>

            <div class="form-group">
                <label>
                    Describe a specific moment you observed this person demonstrating a strength or area for growth *
                    <button type="button" class="field-mic-btn" data-field="example"
                            onclick="toggleFieldRecording('example')"
                            aria-label="Record example">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span class="recording-spinner hidden">‚è∫</span>
                    </button>
                </label>
                <textarea id="example" required maxlength="2000"
                    placeholder="Example: 'During the Q3 planning meeting, they mediated a disagreement between two teams by listening to both sides and proposing a compromise that addressed both concerns. This unblocked a two-week stalemate.'"></textarea>
            </div>

            <div class="form-group">
                <label>
                    Additional comments (optional)
                    <button type="button" class="field-mic-btn" data-field="additional"
                            onclick="toggleFieldRecording('additional')"
                            aria-label="Record additional comments">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span class="recording-spinner hidden">‚è∫</span>
                    </button>
                </label>
                <textarea id="additional" maxlength="2000"
                    placeholder="Any other observations, context, or feedback that doesn't fit the categories above..."></textarea>
            </div>

            <button type="submit" id="submit-btn">Submit Feedback</button>
            </form>
        </div>

        <div class="hidden" id="success-container">
            <div class="message success">
                <strong>Thank you!</strong> Your feedback has been submitted successfully.
            </div>
            <h1>Feedback Submitted</h1>
            <p>Your feedback for <strong id="success-employee-name"></strong> has been recorded.</p>
            <p>Your input will help create a comprehensive performance summary.</p>
            <a href="/"><button>Back to Home</button></a>
        </div>

        <div class="hidden" id="error-container">
            <h1>Invalid Link</h1>
            <p>This review link is invalid or has expired. Please check you have the correct URL.</p>
            <a href="/"><button>Back to Home</button></a>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = getPathParam(1); // /review/{token}
        const loadingEl = document.getElementById('loading');
        const formContainer = document.getElementById('review-form-container');
        const alreadySubmittedEl = document.getElementById('already-submitted');
        const successContainer = document.getElementById('success-container');
        const errorContainer = document.getElementById('error-container');

        // Per-field recording state
        const fieldRecorders = {
            currentField: null,      // "start_doing" | "stop_doing" | etc. | null
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false
        };

        async function startRecording(fieldName) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                fieldRecorders.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                fieldRecorders.audioChunks = [];
                fieldRecorders.currentField = fieldName;

                fieldRecorders.mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) fieldRecorders.audioChunks.push(e.data);
                };

                fieldRecorders.mediaRecorder.start();
                fieldRecorders.isRecording = true;
                updateMicButtonStates(fieldName, 'recording');

                // Auto-stop after 2 minutes (shorter per-field timeout)
                setTimeout(() => {
                    if (fieldRecorders.isRecording && fieldRecorders.currentField === fieldName) {
                        processFieldVoiceFeedback(fieldName);
                    }
                }, 2 * 60 * 1000);

            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    Toast.error('Microphone access denied. Please enable in browser settings.');
                } else {
                    Toast.error('Could not access microphone. Please try again.');
                }
                updateMicButtonStates(null, 'idle');
            }
        }

        function stopRecording() {
            return new Promise(resolve => {
                fieldRecorders.mediaRecorder.onstop = () => {
                    const blob = new Blob(fieldRecorders.audioChunks, { type: 'audio/webm' });
                    fieldRecorders.mediaRecorder.stream.getTracks().forEach(t => t.stop());
                    resolve(blob);
                };
                fieldRecorders.mediaRecorder.stop();
            });
        }

        async function processFieldVoiceFeedback(fieldName) {
            if (!fieldRecorders.isRecording) return;

            fieldRecorders.isRecording = false;
            updateMicButtonStates(fieldName, 'processing');

            try {
                // Stop recording and get audio blob
                const blob = await stopRecording();

                // Upload and transcribe
                const formData = new FormData();
                formData.append('audio_file', blob, 'feedback.webm');
                formData.append('field_name', fieldName);  // NEW: Include field name

                const response = await fetch(`/api/review/${token}/voice-transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Processing failed');
                }

                const data = await response.json();

                // Populate the specific field
                const fieldId = fieldName.replace('_', '-');  // Convert snake_case to kebab-case
                document.getElementById(fieldId).value = data.field_value || '';

                Toast.success(`${getFieldLabel(fieldName)} updated! Review and edit if needed.`);

            } catch (error) {
                Toast.error(`Failed to process recording: ${error.message}`);
            } finally {
                fieldRecorders.currentField = null;
                updateMicButtonStates(null, 'idle');
            }
        }

        function toggleFieldRecording(fieldName) {
            if (fieldRecorders.isRecording) {
                if (fieldRecorders.currentField === fieldName) {
                    // Stop recording for this field
                    processFieldVoiceFeedback(fieldName);
                } else {
                    // Prevent recording different field while one is active
                    Toast.error('Please finish the current recording first.');
                }
            } else {
                // Start recording for this field
                startRecording(fieldName);
            }
        }

        function updateMicButtonStates(activeField, state) {
            // state: 'idle' | 'recording' | 'processing'
            const allButtons = document.querySelectorAll('.field-mic-btn');

            allButtons.forEach(btn => {
                const fieldName = btn.getAttribute('data-field');
                const micIcon = btn.querySelector('.mic-icon');
                const spinner = btn.querySelector('.recording-spinner');

                if (fieldName === activeField) {
                    // Active button
                    if (state === 'recording') {
                        btn.classList.add('recording');
                        btn.classList.remove('processing');
                        micIcon.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        btn.setAttribute('aria-pressed', 'true');
                    } else if (state === 'processing') {
                        btn.classList.remove('recording');
                        btn.classList.add('processing');
                        micIcon.classList.add('hidden');
                        spinner.classList.remove('hidden');
                        btn.disabled = true;
                    }
                } else {
                    // Inactive buttons
                    btn.classList.remove('recording', 'processing');
                    micIcon.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    btn.disabled = (state !== 'idle');
                    btn.setAttribute('aria-pressed', 'false');
                }
            });
        }

        function getFieldLabel(fieldName) {
            const labels = {
                'start_doing': 'Start doing',
                'stop_doing': 'Stop doing',
                'continue_doing': 'Continue doing',
                'example': 'Example',
                'additional': 'Additional comments'
            };
            return labels[fieldName] || fieldName;
        }

        async function loadReviewContext() {
            try {
                const context = await apiFetch(`/review/${token}`);

                loadingEl.classList.add('hidden');

                if (context.already_submitted) {
                    alreadySubmittedEl.classList.remove('hidden');
                    return;
                }

                document.getElementById('employee-name').textContent = context.employee_name;
                document.getElementById('relationship').textContent = formatRelationship(context.relationship);
                formContainer.classList.remove('hidden');

            } catch (error) {
                loadingEl.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }
        }

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            setButtonLoading(submitBtn, true, 'Submitting...');

            try {
                await apiFetch(`/review/${token}`, {
                    method: 'POST',
                    body: {
                        start_doing: document.getElementById('start-doing').value,
                        stop_doing: document.getElementById('stop-doing').value,
                        continue_doing: document.getElementById('continue-doing').value,
                        example: document.getElementById('example').value,
                        additional: document.getElementById('additional').value || null
                    }
                });

                const employeeName = document.getElementById('employee-name').textContent;
                document.getElementById('success-employee-name').textContent = employeeName;

                formContainer.classList.add('hidden');
                successContainer.classList.remove('hidden');
                Toast.success('Feedback submitted successfully!');

            } catch (error) {
                Toast.error(error.message);
                setButtonLoading(submitBtn, false);
            }
        });

        loadReviewContext();
    </script>
</body>
</html>
