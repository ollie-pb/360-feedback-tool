<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Feedback - 360 Feedback</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="site-header site-header--minimal">
            <span class="header-brand">360 Feedback</span>
        </header>

        <div id="loading">
            <div class="loading">Loading review details...</div>
        </div>

        <div class="hidden" id="already-submitted">
            <h1>Feedback Already Submitted</h1>
            <p>You have already submitted feedback for this review request. Thank you for your participation!</p>
            <a href="/"><button>Back to Home</button></a>
        </div>

        <div class="hidden" id="review-form-container">
            <h1>360 Feedback</h1>
        <p>You're providing feedback for <strong id="employee-name"></strong></p>
        <p class="message info">Your relationship: <strong id="relationship"></strong></p>

        <div class="voice-feedback">
            <button id="voice-btn" type="button" onclick="toggleRecording()">
                <span class="default-state">üéôÔ∏è Record voice feedback</span>
                <span class="recording-state hidden">‚èπÔ∏è Stop recording</span>
            </button>
            <span id="recording-indicator" class="hidden">‚óè Recording...</span>
        </div>

        <form id="review-form">
            <div class="form-group">
                <label for="start-doing">What should this person START doing?</label>
                <textarea id="start-doing" required maxlength="2000"
                    placeholder="Example: 'Start delegating more technical decisions to senior team members to free up time for strategic planning.'"></textarea>
            </div>

            <div class="form-group">
                <label for="stop-doing">What should this person STOP doing?</label>
                <textarea id="stop-doing" required maxlength="2000"
                    placeholder="Example: 'Stop taking on too many commitments at once. This leads to rushed work and missed deadlines.'"></textarea>
            </div>

            <div class="form-group">
                <label for="continue-doing">What should this person CONTINUE doing?</label>
                <textarea id="continue-doing" required maxlength="2000"
                    placeholder="Example: 'Continue hosting weekly team syncs. They keep everyone aligned and create space for questions.'"></textarea>
            </div>

            <div class="form-group">
                <label for="example">Describe a specific moment you observed this person demonstrating a strength or area for growth *</label>
                <textarea id="example" required maxlength="2000"
                    placeholder="Example: 'During the Q3 planning meeting, they mediated a disagreement between two teams by listening to both sides and proposing a compromise that addressed both concerns. This unblocked a two-week stalemate.'"></textarea>
            </div>

            <div class="form-group">
                <label for="additional">Additional comments (optional)</label>
                <textarea id="additional" maxlength="2000"
                    placeholder="Any other observations, context, or feedback that doesn't fit the categories above..."></textarea>
            </div>

            <button type="submit" id="submit-btn">Submit Feedback</button>
            </form>
        </div>

        <div class="hidden" id="success-container">
            <div class="message success">
                <strong>Thank you!</strong> Your feedback has been submitted successfully.
            </div>
            <h1>Feedback Submitted</h1>
            <p>Your feedback for <strong id="success-employee-name"></strong> has been recorded.</p>
            <p>Your input will help create a comprehensive performance summary.</p>
            <a href="/"><button>Back to Home</button></a>
        </div>

        <div class="hidden" id="error-container">
            <h1>Invalid Link</h1>
            <p>This review link is invalid or has expired. Please check you have the correct URL.</p>
            <a href="/"><button>Back to Home</button></a>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = getPathParam(1); // /review/{token}
        const loadingEl = document.getElementById('loading');
        const formContainer = document.getElementById('review-form-container');
        const alreadySubmittedEl = document.getElementById('already-submitted');
        const successContainer = document.getElementById('success-container');
        const errorContainer = document.getElementById('error-container');

        // Voice recording state
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.start();
                isRecording = true;
                showRecordingState(true);

                // Auto-stop after 5 minutes
                setTimeout(() => {
                    if (isRecording) {
                        processVoiceFeedback();
                    }
                }, 5 * 60 * 1000);
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    Toast.error('Microphone access denied. Please enable in browser settings.');
                } else {
                    Toast.error('Could not access microphone. Please try again.');
                }
            }
        }

        function stopRecording() {
            return new Promise(resolve => {
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    mediaRecorder.stream.getTracks().forEach(t => t.stop());
                    resolve(blob);
                };
                mediaRecorder.stop();
            });
        }

        async function processVoiceFeedback() {
            if (!isRecording) return;

            isRecording = false;
            showRecordingState(false);

            const voiceBtn = document.getElementById('voice-btn');
            setButtonLoading(voiceBtn, true, 'Processing...');

            try {
                const blob = await stopRecording();
                const formData = new FormData();
                formData.append('audio_file', blob, 'feedback.webm');

                const response = await fetch(`/api/review/${token}/voice-transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Processing failed');
                }

                const fields = await response.json();

                // Populate form fields
                document.getElementById('start-doing').value = fields.start_doing || '';
                document.getElementById('stop-doing').value = fields.stop_doing || '';
                document.getElementById('continue-doing').value = fields.continue_doing || '';
                document.getElementById('example').value = fields.example || '';
                document.getElementById('additional').value = fields.additional || '';

                Toast.success('Voice feedback processed! Review and edit below.');
            } catch (error) {
                Toast.error(error.message || 'Processing failed. Please try again or type your feedback.');
            } finally {
                setButtonLoading(voiceBtn, false);
            }
        }

        function toggleRecording() {
            if (isRecording) {
                processVoiceFeedback();
            } else {
                startRecording();
            }
        }

        function showRecordingState(recording) {
            const voiceBtn = document.getElementById('voice-btn');
            const indicator = document.getElementById('recording-indicator');
            const defaultState = voiceBtn.querySelector('.default-state');
            const recordingState = voiceBtn.querySelector('.recording-state');

            if (recording) {
                defaultState.classList.add('hidden');
                recordingState.classList.remove('hidden');
                indicator.classList.remove('hidden');
            } else {
                defaultState.classList.remove('hidden');
                recordingState.classList.add('hidden');
                indicator.classList.add('hidden');
            }
        }

        async function loadReviewContext() {
            try {
                const context = await apiFetch(`/review/${token}`);

                loadingEl.classList.add('hidden');

                if (context.already_submitted) {
                    alreadySubmittedEl.classList.remove('hidden');
                    return;
                }

                document.getElementById('employee-name').textContent = context.employee_name;
                document.getElementById('relationship').textContent = formatRelationship(context.relationship);
                formContainer.classList.remove('hidden');

            } catch (error) {
                loadingEl.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }
        }

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            setButtonLoading(submitBtn, true, 'Submitting...');

            try {
                await apiFetch(`/review/${token}`, {
                    method: 'POST',
                    body: {
                        start_doing: document.getElementById('start-doing').value,
                        stop_doing: document.getElementById('stop-doing').value,
                        continue_doing: document.getElementById('continue-doing').value,
                        example: document.getElementById('example').value,
                        additional: document.getElementById('additional').value || null
                    }
                });

                const employeeName = document.getElementById('employee-name').textContent;
                document.getElementById('success-employee-name').textContent = employeeName;

                formContainer.classList.add('hidden');
                successContainer.classList.remove('hidden');
                Toast.success('Feedback submitted successfully!');

            } catch (error) {
                Toast.error(error.message);
                setButtonLoading(submitBtn, false);
            }
        });

        loadReviewContext();
    </script>
</body>
</html>
