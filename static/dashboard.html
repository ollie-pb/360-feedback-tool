<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - 360 Feedback Tool</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard</h1>
            <div id="user-info">
                <span id="user-name-display"></span>
                <button onclick="logout()" class="secondary">Logout</button>
            </div>
        </div>

        <div id="loading">Loading your dashboard...</div>

        <div id="dashboard-content" style="display: none;">
            <!-- Cycles I Manage -->
            <div class="form-group" id="managed-cycles-section" style="display: none;">
                <h2>Cycles You Manage</h2>
                <p>Review and discuss feedback with your direct reports.</p>
                <div id="managed-cycles-list"></div>
            </div>

            <hr id="managed-cycles-hr" style="display: none;">

            <!-- My Feedback Cycles -->
            <div class="form-group">
                <h2>My Feedback Cycles</h2>
                <p>Cycles where you are collecting feedback.</p>
                <div id="my-cycles-list"></div>
                <a href="/nominate"><button>Start New Feedback Cycle</button></a>
            </div>

            <hr>

            <!-- Pending Reviews -->
            <div class="form-group">
                <h2>Feedback Requests</h2>
                <p>Reviews you've been asked to provide.</p>
                <div id="pending-reviews-list"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Check if logged in
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = '/';
        }

        // Display user info
        document.getElementById('user-name-display').textContent = user.name + ' (' + user.email + ')';

        // Load dashboard data
        loadDashboard();

        async function loadDashboard() {
            try {
                const response = await fetch(`/api/auth/dashboard/${encodeURIComponent(user.email)}`);
                if (!response.ok) {
                    throw new Error('Failed to load dashboard');
                }

                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading dashboard: ' + error.message;
            }
        }

        function renderDashboard(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';

            // Render managed cycles (cycles where user is the manager)
            const managedContainer = document.getElementById('managed-cycles-list');
            if (data.managed_cycles && data.managed_cycles.length > 0) {
                document.getElementById('managed-cycles-section').style.display = 'block';
                document.getElementById('managed-cycles-hr').style.display = 'block';
                managedContainer.innerHTML = data.managed_cycles.map(cycle => `
                    <div class="card">
                        <h3>${cycle.title || 'Feedback Cycle'}</h3>
                        <p><strong>Employee:</strong> ${cycle.subject_name}</p>
                        <p><strong>Progress:</strong> ${cycle.submitted_count} of ${cycle.total_reviewers} reviews submitted</p>
                        <p><strong>Status:</strong> ${cycle.status}</p>
                        <a href="/cycle/${cycle.id}"><button class="secondary">View & Review Feedback</button></a>
                    </div>
                `).join('');
            }

            // Render my cycles
            const cyclesContainer = document.getElementById('my-cycles-list');
            if (data.my_cycles.length === 0) {
                cyclesContainer.innerHTML = '<p class="empty-state">No feedback cycles yet. Start one to collect feedback from your colleagues.</p>';
            } else {
                cyclesContainer.innerHTML = data.my_cycles.map(cycle => `
                    <div class="card">
                        <h3>${cycle.title || 'Feedback Cycle'}</h3>
                        <p><strong>Progress:</strong> ${cycle.submitted_count} of ${cycle.total_reviewers} reviews submitted</p>
                        <p><strong>Manager:</strong> ${cycle.manager_name || 'Not assigned'}</p>
                        <p><strong>Status:</strong> ${cycle.status}</p>
                    </div>
                `).join('');
            }

            // Render pending reviews
            const reviewsContainer = document.getElementById('pending-reviews-list');
            const pendingOnly = data.pending_reviews.filter(r => r.status === 'pending');
            const submittedOnly = data.pending_reviews.filter(r => r.status === 'submitted');

            if (data.pending_reviews.length === 0) {
                reviewsContainer.innerHTML = '<p class="empty-state">No feedback requests at this time.</p>';
            } else {
                let html = '';

                if (pendingOnly.length > 0) {
                    html += '<h3>Pending</h3>';
                    html += pendingOnly.map(review => `
                        <div class="card pending">
                            <p>Feedback for <strong>${review.employee_name}</strong></p>
                            <p><em>Your relationship: ${review.relationship} (${review.frequency} interaction)</em></p>
                            <a href="/review/${review.token}"><button>Submit Feedback</button></a>
                        </div>
                    `).join('');
                }

                if (submittedOnly.length > 0) {
                    html += '<h3>Completed</h3>';
                    html += submittedOnly.map(review => `
                        <div class="card completed">
                            <p>Feedback for <strong>${review.employee_name}</strong></p>
                            <p><em>Your relationship: ${review.relationship}</em></p>
                            <span class="status-badge">Submitted</span>
                        </div>
                    `).join('');
                }

                reviewsContainer.innerHTML = html;
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
</body>
</html>
